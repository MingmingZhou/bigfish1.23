<?xml version="1.0" encoding="UTF-8" ?>

<simple-methods xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="http://ofbiz.apache.org/dtds/simple-methods.xsd">

    <simple-method method-name="createProductReview" short-description="Create Product review" login-required="false">

         <call-map-processor in-map-name="parameters" out-map-name="reviewContext">
             <simple-map-processor name="productReview">
                <process field="overallRate"><copy to-field="productRating"/><not-empty><fail-property resource="OSafeUiLabels" property="OverallRatingMissingError"/></not-empty>
                </process>
                <process field="qualityRate"><copy to-field="qualityRating"/></process>
                <process field="effectivenessRate"><copy to-field="effectivenessRating"/></process>
                <process field="satisfactionRate"><copy to-field="satisfactionRating"/></process>
                <process field="productId"><copy to-field="productId"/></process>
                <process field="productStoreId"><copy to-field="productStoreId"/></process>
                <process field="REVIEW_NICK_NAME"><copy to-field="reviewNickName"/></process>
                <process field="REVIEW_TITLE"><copy to-field="reviewTitle"/></process>
                <process field="REVIEW_TEXT"><copy to-field="productReview"/></process>
                <process field="REVIEW_GENDER"><copy to-field="reviewGender"/></process>
                <process field="REVIEW_AGE"><copy to-field="reviewAge"/></process>
                <process field="REVIEW_LOCATION"><copy to-field="reviewLocation"/></process>
                <process field="REVIEW_PRIVATE_NOTE"><copy to-field="reviewPrivateNote"/></process>
                <process field="REVIEW_CUSTOM_01"><copy to-field="reviewCustom01"/></process>
             </simple-map-processor>

         </call-map-processor>
        <if-compare field="parameters.REVIEW_TEXT_MANDATORY" operator="equals" value="Y">
         <if-empty field="parameters.REVIEW_TEXT">
             <property-to-field field="tempErrorMessage" resource="OSafeUiLabels" property="ReviewTextMissingError"/>
             <string-to-list string="${tempErrorMessage}" message-field="REVIEW_TEXT" list="error_list"/>
         </if-empty>
        </if-compare>
         
        <if-compare field="parameters.REVIEW_NICK_NAME_MANDATORY" operator="equals" value="Y">
         <if-empty field="parameters.REVIEW_NICK_NAME">
             <property-to-field field="tempErrorMessage" resource="OSafeUiLabels" property="NickNameMissingError"/>
             <string-to-list string="${tempErrorMessage}" message-field="REVIEW_NICK_NAME" list="error_list"/>
         </if-empty>
        </if-compare>
        <if-compare field="parameters.REVIEW_TITLE_MANDATORY" operator="equals" value="Y">
         <if-empty field="parameters.REVIEW_TITLE">
             <property-to-field field="tempErrorMessage" resource="OSafeUiLabels" property="ReviewTitleMissingError"/>
             <string-to-list string="${tempErrorMessage}" message-field="REVIEW_TITLE" list="error_list"/>
         </if-empty>
        </if-compare>
        <if-compare field="parameters.REVIEW_GENDER_MANDATORY" operator="equals" value="Y">
         <if-empty field="parameters.REVIEW_GENDER">
             <property-to-field field="tempErrorMessage" resource="OSafeUiLabels" property="ReviewGenderMissingError"/>
             <string-to-list string="${tempErrorMessage}" message-field="REVIEW_GENDER" list="error_list"/>
         </if-empty>
        </if-compare>
        <if-compare field="parameters.REVIEW_AGE_MANDATORY" operator="equals" value="Y">
         <if-empty field="parameters.REVIEW_AGE">
             <property-to-field field="tempErrorMessage" resource="OSafeUiLabels" property="ReviewAgeMissingError"/>
             <string-to-list string="${tempErrorMessage}" message-field="REVIEW_AGE" list="error_list"/>
         </if-empty>
        </if-compare>
        <if-compare field="parameters.REVIEW_CUSTOM_01_MANDATORY" operator="equals" value="Y">
         <if-empty field="parameters.REVIEW_CUSTOM_01">
             <property-to-field field="tempErrorMessage" resource="OSafeUiLabels" property="ReviewCustomMissingError"/>
             <string-to-list string="${tempErrorMessage}" message-field="REVIEW_CUSTOM_01" list="error_list"/>
         </if-empty>
        </if-compare>
        
        <if-compare field="parameters.REVIEW_LOCATION_MANDATORY" operator="equals" value="Y">
         <if-empty field="parameters.REVIEW_LOCATION">
             <property-to-field field="tempErrorMessage" resource="OSafeUiLabels" property="ReviewLocationMissingError"/>
             <string-to-list string="${tempErrorMessage}" message-field="REVIEW_LOCATION" list="error_list"/>
         </if-empty>
        </if-compare>
        
        <if-not-empty field="parameters.REVIEW_TEXT">
			<call-object-method method-name="length" obj-field="parameters.REVIEW_TEXT" ret-field="reviewTextLength"/>
			<!-- check if length of review is less than system param REVIEW_MIN_CHAR-->
        	<if-empty field="parameters.REVIEW_MIN_CHAR">
				<set field="parameters.REVIEW_MIN_CHAR" type="Integer" value="0"/>
				<else><!-- check if it is an integer -->
					<call-class-method class-name="org.ofbiz.base.util.UtilValidate" method-name="isInteger" ret-field="minCharIsInt">
			            <field field="parameters.REVIEW_MIN_CHAR" type="String"/>
			        </call-class-method>
			        <if-compare operator="equals" value="false" field="minCharIsInt" type="Boolean">
			            <set field="parameters.REVIEW_MIN_CHAR" type="Integer" value="0"/>
			        </if-compare>
				</else>
			</if-empty>
            <if-compare field="reviewTextLength" operator="less" value="${parameters.REVIEW_MIN_CHAR}" type="Integer">
                <property-to-field field="tempErrorMessage" resource="OSafeUiLabels" property="ReviewTextShortError"/>
                <string-to-list string="${tempErrorMessage}" message-field="REVIEW_TEXT" list="error_list"/>
            </if-compare>
			<!-- check if length of review is greater than system param REVIEW_MAX_CHAR-->
			<if-empty field="parameters.REVIEW_MAX_CHAR">
				<set field="parameters.REVIEW_MAX_CHAR" type="Integer" value="0"/>
				<else><!-- check if it is an integer -->
					<call-class-method class-name="org.ofbiz.base.util.UtilValidate" method-name="isInteger" ret-field="maxCharIsInt">
			            <field field="parameters.REVIEW_MAX_CHAR" type="String"/>
			        </call-class-method>
			        <if-compare operator="equals" value="false" field="maxCharIsInt" type="Boolean">
			            <set field="parameters.REVIEW_MAX_CHAR" type="Integer" value="0"/>
			        </if-compare>
				</else>
			</if-empty>
			<!-- if REVIEW_MAX_CHAR equals 0 then is can have an unlimited amount of chars -->
			<if-compare field="parameters.REVIEW_MAX_CHAR" operator="equals" value="0" type="Integer">
				<else>
					<if-compare field="reviewTextLength" operator="greater" value="${parameters.REVIEW_MAX_CHAR}" type="Integer">
						<property-to-field field="tempErrorMessage" resource="OSafeUiLabels" property="ReviewTextLongError"/>
						<string-to-list string="${tempErrorMessage}" message-field="REVIEW_TEXT" list="error_list"/>
					</if-compare>
				</else>
			</if-compare>
        </if-not-empty>
        
        <check-errors/>
        <set-service-fields service-name="createProductReview" map="reviewContext" to-map="createReviewCtx"/>
        <if-not-empty field="reviewContext.productRating">
            <set field="createReviewCtx.productRating" type="BigDecimal" value="${reviewContext.productRating}"/>
        </if-not-empty>
        <if-not-empty field="reviewContext.effectivenessRating">
            <set field="createReviewCtx.effectivenessRating" type="BigDecimal" value="${reviewContext.effectivenessRating}"/>
        </if-not-empty>
        <if-not-empty field="reviewContext.qualityRating">
            <set field="createReviewCtx.qualityRating" type="BigDecimal" value="${reviewContext.qualityRating}"/>
        </if-not-empty>

        <if-not-empty field="reviewContext.satisfactionRating">
            <set field="createReviewCtx.satisfactionRating" type="BigDecimal" value="${reviewContext.satisfactionRating}"/>
        </if-not-empty>
		
		<set field="userLogin" from-field="parameters.userLogin"/>
        <if-empty field="userLogin">
            <entity-one entity-name="UserLogin" value-field="anonymousUserLogin">
                <field-map field-name="userLoginId" value="anonymous"/>
            </entity-one>
            <set-current-user-login value-field="anonymousUserLogin"/>
        <else>
            <set-current-user-login value-field="userLogin"/>
        </else>
        </if-empty>

        <call-service service-name="createProductReview" in-map-name="createReviewCtx" include-user-login="true"/> 
    </simple-method>
    
    <simple-method method-name="reloadProductReviews" short-description="Select review screen to reload after sort option is selected" login-required="false">
    
    	<set field="productId" from-field="parameters.productId"/>
    	<set field="viewSize" from-field="parameters.viewSize"/>
    	<set field="viewIndex" from-field="parameters.viewIndex"/>
    	<set field="reviewScreen" from-field="parameters.reviewScreen"/>
    	<set field="sortReviewBy" from-field="parameters.sortReviewBy"/>
    	
    	<field-to-request field="productId"/>
    	<field-to-request field="viewSize"/>
    	<field-to-request field="viewIndex"/>
    	<field-to-request field="reviewScreen"/>
    	<field-to-request field="sortReviewBy"/>
    	
    	<if-not-empty field="parameters.reviewScreen">
    		<if-compare operator="equals" value="pdp" field="parameters.reviewScreen">
    			<return response-code="sortPdpReview"/>
    			<else>
	    			<if-compare operator="equals" value="pdpTabs" field="parameters.reviewScreen">
	    				<return response-code="sortPdpTabsReview"/>
	    				<else>
			    			<if-compare operator="equals" value="quicklook" field="parameters.reviewScreen">
			    				<return response-code="sortQuicklookReview"/>
			    			</if-compare>
		    			</else>
	    			</if-compare>
    			</else>
    		</if-compare>
    	</if-not-empty>
    	
    </simple-method>
    
</simple-methods>
